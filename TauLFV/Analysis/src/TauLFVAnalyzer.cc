#include <sstream>
#include <bitset>

#include "TauLFVAnalyzer.h"
#include "TauLFVHistograms.h"
#include "Tools.h"

//////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////
TauLFVAnalyzer::TauLFVAnalyzer(const std::string & aName) : Analyzer(aName){ }
//////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////
TauLFVAnalyzer::~TauLFVAnalyzer(){

  if(myHistos_) delete myHistos_;
}
//////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////
Analyzer* TauLFVAnalyzer::clone() const {

        TauLFVAnalyzer* clone = new TauLFVAnalyzer(name());
        clone->setHistos(myHistos_);
        return clone;

};
//////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////
void TauLFVAnalyzer::initialize(TDirectory* aDir,
                             pat::strbitset *aSelections){

  mySelections_ = aSelections;

  myHistos_ = new TauLFVHistograms(aDir);
}
//////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////
void TauLFVAnalyzer::finalize(){

        myHistos_->finalizeHistograms();
}
//////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////
void TauLFVAnalyzer::clear(){

  std::cout<<__FUNCTION__<<std::endl;

  TLorentzVector emptyP4;

  aMuon1.setP4(emptyP4);
  aMuon2.setP4(emptyP4);
  aMuon3.setP4(emptyP4);
  
}
//////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////
void TauLFVAnalyzer::setAnalysisObjects(const EventProxyHTT & myEventProxy){

  clear();
  
  aEvent = *myEventProxy.event;

  for(auto aLepton : *myEventProxy.leptons) {
    bool isMuon = std::abs(aLepton.getPDGid())==13;
    if(isMuon && aMuon1.getP4().E()<1E-3) aMuon1 = aLepton;
    else if(isMuon && aMuon2.getP4().E()<1E-3) aMuon2 = aLepton;
    else if(isMuon && aMuon3.getP4().E()<1E-3) aMuon3 = aLepton;
  }  
}
//////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////
void TauLFVAnalyzer::fillControlHistos(const std::string & hNameSuffix, float eventWeight){
       
  const TLorentzVector & the3Mu = aMuon1.getP4() + aMuon2.getP4() + aMuon3.getP4();
	
  myHistos_->fill1DHistogram("h1DMass3Mu_"+hNameSuffix, the3Mu.M(), eventWeight);

  aMuon1.getP4().Print();
  aMuon2.getP4().Print();
  aMuon3.getP4().Print();

  std::cout<<"3Mu mass: "<<the3Mu.M()<<std::endl;

}
//////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////
bool TauLFVAnalyzer::analyze(const EventProxyBase& iEvent){

  const EventProxyHTT & myEventProxy = static_cast<const EventProxyHTT&>(iEvent);
  setAnalysisObjects(myEventProxy);
  sampleName = TauLFVAnalysis::getSampleName(myEventProxy);

  std::string hNameSuffix = sampleName;
  float eventWeight = 1.0;

  fillControlHistos(hNameSuffix, eventWeight);

  return true;
}
//////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////
